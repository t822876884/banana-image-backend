# Nano Banana AI图片处理应用 - 部署文档

## 概述

本文档详细说明了 Nano Banana AI图片处理应用的开发环境和生产环境部署方法。

## 系统要求

### 基础环境
- **Node.js**: >= 16.0.0
- **npm**: >= 8.0.0
- **MySQL**: >= 8.0
- **Redis**: >= 6.0 (可选，用于缓存)
- **Docker**: >= 20.10 (容器化部署)
- **Docker Compose**: >= 2.0

### 硬件要求
- **开发环境**: 2核CPU, 4GB内存, 20GB存储
- **生产环境**: 4核CPU, 8GB内存, 100GB存储

## 项目结构
```
banana-image-backend/
├── src/                    # 源代码目录
│   ├── app.js             # 应用入口
│   ├── database/          # 数据库相关
│   ├── middleware/        # 中间件
│   ├── routes/           # 路由定义
│   └── utils/            # 工具函数
├── uploads/              # 文件上传目录
├── logs/                 # 日志目录
├── .env                  # 环境变量配置
├── .env.example          # 环境变量模板
├── .env.prod             # 生产环境变量模板
├── docker-compose.yml    # Docker编排文件
├── docker-compose.prod.yml # 生产环境Docker编排
├── Dockerfile            # Docker镜像构建文件
├── package.json          # 项目依赖
└── README.md            # 项目说明
```

## 开发环境部署

### 方式一：本地直接运行

#### 1. 克隆项目
```bash
git clone <repository-url>
cd banana-image-backend
```

#### 2. 安装依赖
```bash
npm install
```

#### 3. 环境配置
复制环境变量模板并配置：
```bash
cp .env.example .env
```

编辑 `.env` 文件：
```env
# 数据库配置
DB_HOST=127.0.0.1
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=banana_image

# Redis配置（可选）
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
REDIS_PASSWORD=

# JWT配置
JWT_SECRET=your_jwt_secret_key_here
JWT_EXPIRES_IN=1h
REFRESH_TOKEN_SECRET=your_refresh_token_secret_here
REFRESH_TOKEN_EXPIRES_IN=7d

# 服务器配置
PORT=3000
NODE_ENV=development

# Google AI API配置
GOOGLE_AI_API_KEY=your_google_ai_api_key

# 代理配置（如需要）
HTTP_PROXY=
HTTPS_PROXY=

# 文件上传配置
UPLOAD_PATH=uploads
MAX_FILE_SIZE=10485760
ALLOWED_IMAGE_TYPES=image/jpeg,image/png,image/webp,image/gif

# CORS配置
ALLOWED_ORIGINS=http://127.0.0.1:8080,http://localhost:8080
```

#### 4. 数据库初始化
```bash
# 创建数据库
mysql -u root -p -e "CREATE DATABASE banana_image CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# 运行数据库迁移
npm run db:init
```

#### 5. 启动服务
```bash
# 开发模式（自动重启）
npm run dev

# 或者普通启动
npm start
```

#### 6. 验证部署
访问 `http://localhost:3000/health` 检查服务状态
访问 `http://localhost:3000/api-docs` 查看API文档

### 方式二：Docker开发环境

#### 1. 使用Docker Compose启动
```bash
# 启动开发环境（包含MySQL和Redis）
docker-compose -f docker-compose.dev.yml up -d

# 查看日志
docker-compose -f docker-compose.dev.yml logs -f app

# 停止服务
docker-compose -f docker-compose.dev.yml down
```

#### 2. 数据库初始化
```bash
# 进入容器执行迁移
docker-compose -f docker-compose.dev.yml exec app npm run db:init
```

### 方式三：连接外部数据库

如果您已有MySQL和Redis服务，可以使用简化版本：

#### 1. 配置环境变量
编辑 `.env` 文件，设置正确的数据库连接信息：
```env
DB_HOST=your_mysql_host
DB_PORT=your_mysql_port
DB_PASSWORD=your_mysql_password
REDIS_HOST=your_redis_host
REDIS_PORT=your_redis_port
REDIS_PASSWORD=your_redis_password
```

#### 2. 启动应用容器
```bash
# 使用简化版Docker Compose
docker-compose -f docker-compose.simple.yml up -d

# 或者直接运行应用
docker-compose up -d
```

## 生产环境部署

### 环境准备

#### 1. 服务器配置
- **操作系统**: Ubuntu 20.04+ / CentOS 8+ / RHEL 8+
- **防火墙**: 开放3000端口（或自定义端口）
- **域名**: 配置域名解析（可选）
- **SSL证书**: 配置HTTPS（推荐）

#### 2. 安装Docker和Docker Compose
```bash
# Ubuntu/Debian
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

### 方式一：一键部署脚本

#### 1. 配置生产环境变量
```bash
cp .env.prod .env
```

编辑 `.env` 文件，配置生产环境参数：
```env
# 数据库配置（使用您的生产数据库）
DB_HOST=your_production_mysql_host
DB_PORT=53306
DB_USER=root
DB_PASSWORD=your_production_password
DB_NAME=banana_image

# Redis配置
REDIS_HOST=your_production_redis_host
REDIS_PORT=56379
REDIS_PASSWORD=your_redis_password

# JWT配置（生产环境请使用强密钥）
JWT_SECRET=your_very_strong_jwt_secret_key_here
REFRESH_TOKEN_SECRET=your_very_strong_refresh_token_secret_here

# 服务器配置
PORT=3000
NODE_ENV=production

# Google AI API配置
GOOGLE_AI_API_KEY=your_production_google_ai_api_key

# CORS配置（设置您的前端域名）
ALLOWED_ORIGINS=https://yourdomain.com,https://www.yourdomain.com
```

#### 2. 执行一键部署
```bash
# 给脚本执行权限
chmod +x deploy-prod.sh

# 执行部署
./deploy-prod.sh
```

部署脚本会自动完成：
- 检查必要文件
- 停止现有服务
- 构建生产镜像
- 准备数据目录
- 启动服务
- 检查服务状态

#### 3. 验证部署
```bash
# 检查服务状态
docker-compose -f docker-compose.prod.yml ps

# 查看日志
docker-compose -f docker-compose.prod.yml logs -f app

# 检查健康状态
curl http://localhost:3000/health
```

### 方式二：手动部署

#### 1. 构建生产镜像
```bash
# 构建镜像
chmod +x build-prod.sh
./build-prod.sh
```

#### 2. 准备数据目录
```bash
# 创建必要目录
mkdir -p uploads logs
chmod 755 uploads logs
```

#### 3. 启动生产服务
```bash
# 启动服务
docker-compose -f docker-compose.prod.yml up -d

# 检查状态
docker-compose -f docker-compose.prod.yml ps
```

#### 4. 数据库初始化
```bash
# 执行数据库迁移
docker-compose -f docker-compose.prod.yml exec app npm run db:init
```

### 方式三：PM2部署（非容器）

#### 1. 安装PM2
```bash
npm install -g pm2
```

#### 2. 配置PM2
项目已包含 `ecosystem.config.js` 配置文件：
```javascript
module.exports = {
  apps: [{
    name: 'nano-banana-backend',
    script: 'start.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'development',
      PORT: 3000
    },
    env_production: {
      NODE_ENV: 'production',
      PORT: 3000
    }
  }]
};
```

#### 3. 启动服务
```bash
# 生产模式启动
pm2 start ecosystem.config.js --env production

# 查看状态
pm2 status

# 查看日志
pm2 logs

# 重启服务
pm2 restart nano-banana-backend
```

## 反向代理配置

### Nginx配置示例

创建 `/etc/nginx/sites-available/nano-banana` 文件：
```nginx
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;
    
    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;
    
    # SSL配置
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    
    # 文件上传大小限制
    client_max_body_size 10M;
    
    # API代理
    location /api/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
    
    # 静态文件代理
    location /uploads/ {
        proxy_pass http://localhost:3000;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # 健康检查
    location /health {
        proxy_pass http://localhost:3000;
        access_log off;
    }
    
    # API文档
    location /api-docs {
        proxy_pass http://localhost:3000;
    }
}
```

启用配置：
```bash
sudo ln -s /etc/nginx/sites-available/nano-banana /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

## 服务管理

### Docker Compose管理

```bash
# 查看服务状态
docker-compose -f docker-compose.prod.yml ps

# 查看日志
docker-compose -f docker-compose.prod.yml logs -f app

# 重启服务
docker-compose -f docker-compose.prod.yml restart app

# 停止服务
docker-compose -f docker-compose.prod.yml stop

# 完全停止并删除容器
docker-compose -f docker-compose.prod.yml down

# 更新服务
docker-compose -f docker-compose.prod.yml pull
docker-compose -f docker-compose.prod.yml up -d
```

### PM2管理

```bash
# 查看状态
pm2 status

# 重启应用
pm2 restart nano-banana-backend

# 停止应用
pm2 stop nano-banana-backend

# 删除应用
pm2 delete nano-banana-backend

# 查看日志
pm2 logs nano-banana-backend

# 监控
pm2 monit
```

## 数据备份

### 数据库备份

```bash
# 创建备份脚本
cat > backup-db.sh << 'EOF'
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/mysql"
mkdir -p $BACKUP_DIR

mysqldump -h your_mysql_host -P 53306 -u root -p'your_password' \
  --single-transaction --routines --triggers \
  banana_image > $BACKUP_DIR/banana_image_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/banana_image_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete
EOF

chmod +x backup-db.sh

# 添加到定时任务
crontab -e
# 添加：0 2 * * * /path/to/backup-db.sh
```

### 文件备份

```bash
# 备份上传文件
tar -czf uploads_backup_$(date +%Y%m%d).tar.gz uploads/

# 同步到远程服务器
rsync -avz uploads/ user@backup-server:/backup/uploads/
```

## 监控和日志

### 日志管理

```bash
# 查看应用日志
docker-compose -f docker-compose.prod.yml logs -f app

# 日志轮转配置
cat > /etc/logrotate.d/nano-banana << 'EOF'
/path/to/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 root root
    postrotate
        docker-compose -f /path/to/docker-compose.prod.yml restart app
    endscript
}
EOF
```

### 性能监控

```bash
# 安装监控工具
npm install -g pm2

# 启用监控
pm2 install pm2-server-monit
```

## 安全配置

### 防火墙配置

```bash
# Ubuntu UFW
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 3000/tcp  # 如果直接暴露应用端口
sudo ufw enable

# CentOS firewalld
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --permanent --add-port=3000/tcp
sudo firewall-cmd --reload
```

### SSL证书配置

```bash
# 使用Let's Encrypt
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com

# 自动续期
sudo crontab -e
# 添加：0 12 * * * /usr/bin/certbot renew --quiet
```

## 故障排除

### 常见问题

#### 1. 数据库连接失败
```bash
# 检查数据库连接
mysql -h your_host -P your_port -u your_user -p

# 检查网络连通性
telnet your_host your_port

# 查看应用日志
docker-compose logs app
```

#### 2. 文件上传失败
```bash
# 检查目录权限
ls -la uploads/
chmod 755 uploads/

# 检查磁盘空间
df -h
```

#### 3. 内存不足
```bash
# 检查内存使用
free -h
docker stats

# 增加swap空间
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

#### 4. 端口被占用
```bash
# 查看端口占用
sudo netstat -tlnp | grep :3000
sudo lsof -i :3000

# 杀死占用进程
sudo kill -9 <PID>
```

### 日志分析

```bash
# 查看错误日志
docker-compose logs app | grep ERROR

# 查看访问日志
docker-compose logs app | grep "GET\|POST\|PUT\|DELETE"

# 实时监控日志
tail -f logs/app.log
```

## 性能优化

### 应用优化

1. **启用集群模式**：使用PM2的cluster模式
2. **数据库连接池**：配置合适的连接池大小
3. **Redis缓存**：启用Redis缓存提高性能
4. **文件压缩**：启用gzip压缩
5. **CDN加速**：使用CDN加速静态资源

### 数据库优化

```sql
-- 创建索引
CREATE INDEX idx_user_id ON images(user_id);
CREATE INDEX idx_created_at ON process_records(created_at);
CREATE INDEX idx_status ON process_records(status);

-- 优化配置
-- 在my.cnf中添加：
[mysqld]
innodb_buffer_pool_size = 1G
innodb_log_file_size = 256M
max_connections = 200
```

## 更新部署

### 应用更新

```bash
# 1. 备份当前版本
docker-compose -f docker-compose.prod.yml down
cp -r . ../backup_$(date +%Y%m%d)

# 2. 拉取新代码
git pull origin main

# 3. 重新构建和部署
./deploy-prod.sh

# 4. 验证更新
curl http://localhost:3000/health
```

### 数据库迁移

```bash
# 执行数据库迁移
docker-compose -f docker-compose.prod.yml exec app npm run db:migrate
```

## 扩展部署

### 负载均衡

使用Nginx进行负载均衡：

```nginx
upstream nano_banana_backend {
    server 127.0.0.1:3000;
    server 127.0.0.1:3001;
    server 127.0.0.1:3002;
}

server {
    listen 80;
    location / {
        proxy_pass http://nano_banana_backend;
    }
}
```

### 容器编排

使用Docker Swarm或Kubernetes进行容器编排部署。

## 联系支持

如果在部署过程中遇到问题，请：

1. 查看日志文件获取详细错误信息
2. 检查环境配置是否正确
3. 确认网络和防火墙设置
4. 参考故障排除章节
5. 联系技术支持团队

---

**注意**: 请根据实际环境调整配置参数，确保安全性和性能要求。