# Nano Banana AI图片处理应用 - 接口对接文档

## 概述

Nano Banana 是一个基于 Node.js + Express + MySQL 的AI图片处理应用后端接口，提供用户认证、图片上传处理、AI模型配置、场景管理等功能。

## 基础信息

- **基础URL**: `http://localhost:3000/api`
- **认证方式**: Bearer Token (JWT)
- **数据格式**: JSON
- **字符编码**: UTF-8

## 通用响应格式

### 成功响应
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {}
}
```

### 错误响应
```json
{
  "code": 400,
  "message": "错误信息"
}
```

## 认证接口 (/api/auth)

### 1. 用户注册
- **接口**: `POST /api/auth/register`
- **描述**: 用户注册账号
- **请求参数**:
```json
{
  "username": "用户名",
  "password": "密码",
  "phone": "手机号（可选）",
  "email": "邮箱（可选）"
}
```
- **响应数据**:
```json
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "token": "访问令牌",
    "refreshToken": "刷新令牌",
    "user": {
      "id": "用户ID",
      "username": "用户名",
      "nickname": "昵称",
      "phone": "手机号",
      "email": "邮箱",
      "avatar": "头像URL",
      "joinDate": "注册时间"
    }
  }
}
```

### 2. 用户登录
- **接口**: `POST /api/auth/login`
- **描述**: 用户登录（支持用户名/手机号/邮箱登录）
- **请求参数**:
```json
{
  "username": "用户名/手机号/邮箱",
  "password": "密码"
}
```
- **响应数据**:
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "userId": "用户ID",
    "token": "访问令牌",
    "refreshToken": "刷新令牌",
    "userInfo": {
      "id": "用户ID",
      "username": "用户名",
      "nickname": "昵称",
      "phone": "手机号",
      "email": "邮箱",
      "avatar": "头像URL",
      "joinDate": "注册时间"
    }
  }
}
```

### 3. 刷新Token
- **接口**: `POST /api/auth/refresh-token`
- **描述**: 刷新访问令牌
- **请求参数**:
```json
{
  "refreshToken": "刷新令牌"
}
```

### 4. 退出登录
- **接口**: `POST /api/auth/logout`
- **描述**: 用户退出登录
- **认证**: 需要Bearer Token
- **请求参数**:
```json
{
  "refreshToken": "刷新令牌（可选）"
}
```

## 用户管理接口 (/api/user)

### 1. 获取用户资料
- **接口**: `GET /api/user/profile`
- **描述**: 获取当前用户的详细资料
- **认证**: 需要Bearer Token
- **响应数据**:
```json
{
  "code": 200,
  "data": {
    "id": "用户ID",
    "username": "用户名",
    "nickname": "昵称",
    "gender": "性别",
    "birthday": "生日",
    "phone": "手机号",
    "email": "邮箱",
    "avatar": "头像URL",
    "joinDate": "注册时间",
    "contact": {
      "wechat": "微信号",
      "qq": "QQ号"
    }
  }
}
```

### 2. 更新用户资料
- **接口**: `PUT /api/user/profile`
- **描述**: 更新用户资料信息
- **认证**: 需要Bearer Token
- **请求参数**:
```json
{
  "nickname": "昵称",
  "gender": "性别",
  "birthday": "生日",
  "contact": {
    "wechat": "微信号",
    "qq": "QQ号"
  }
}
```

### 3. 上传头像
- **接口**: `POST /api/user/avatar`
- **描述**: 上传用户头像
- **认证**: 需要Bearer Token
- **请求类型**: multipart/form-data
- **请求参数**: 
  - `avatar`: 头像文件

### 4. 修改密码
- **接口**: `PUT /api/user/password`
- **描述**: 修改用户密码
- **认证**: 需要Bearer Token
- **请求参数**:
```json
{
  "currentPassword": "当前密码",
  "newPassword": "新密码"
}
```

### 5. 绑定手机号
- **接口**: `POST /api/user/bind-phone`
- **描述**: 绑定手机号
- **认证**: 需要Bearer Token
- **请求参数**:
```json
{
  "phone": "手机号",
  "code": "验证码"
}
```

### 6. 绑定邮箱
- **接口**: `POST /api/user/bind-email`
- **描述**: 绑定邮箱
- **认证**: 需要Bearer Token
- **请求参数**:
```json
{
  "email": "邮箱",
  "code": "验证码"
}
```

## 图片处理接口 (/api/image)

### 1. 图片上传
- **接口**: `POST /api/image/upload`
- **描述**: 上传图片并进行AI处理
- **认证**: 需要Bearer Token
- **请求类型**: multipart/form-data
- **请求参数**:
  - `image`: 图片文件
  - `sceneType`: 场景类型
- **响应数据**:
```json
{
  "code": 200,
  "data": {
    "imageId": "图片ID",
    "processId": "处理ID",
    "originalUrl": "原图URL",
    "thumbnailUrl": "缩略图URL",
    "userDirectory": "用户目录",
    "status": "processing"
  }
}
```

### 2. 图片处理
- **接口**: `POST /api/image/process`
- **描述**: 对已上传的图片进行AI处理
- **认证**: 需要Bearer Token
- **请求参数**:
```json
{
  "imageId": "图片ID",
  "sceneType": "场景类型",
  "prompt": "处理提示词（可选）",
  "modelConfig": {
    "modelId": "模型ID",
    "temperature": 0.7,
    "maxTokens": 2048
  }
}
```

### 3. 获取处理状态
- **接口**: `GET /api/image/process-status/:processId`
- **描述**: 获取图片处理进度和状态
- **认证**: 需要Bearer Token
- **响应数据**:
```json
{
  "code": 200,
  "data": {
    "processId": "处理ID",
    "status": "processing|completed|failed",
    "progress": 75,
    "currentStep": "当前步骤",
    "estimatedTime": 30,
    "startTime": "开始时间",
    "preview": {
      "hasImages": true,
      "imageCount": 2,
      "hasTextResponse": true
    }
  }
}
```

### 4. 获取处理结果
- **接口**: `GET /api/image/process-result/:processId`
- **描述**: 获取图片处理完整结果
- **认证**: 需要Bearer Token
- **查询参数**:
  - `includeOriginal`: 是否包含原图（true/false）
- **响应数据**:
```json
{
  "code": 200,
  "data": {
    "processId": "处理ID",
    "status": "completed",
    "textResponse": "AI分析文本",
    "images": [
      {
        "id": "图片ID",
        "url": "图片URL",
        "thumbnailUrl": "缩略图URL",
        "type": "original|processed",
        "fileSize": 1024000,
        "dimensions": {
          "width": 1920,
          "height": 1080
        }
      }
    ],
    "model": "使用的模型",
    "processTime": 25.5,
    "sceneConfig": {},
    "completedAt": "完成时间",
    "meta": {
      "totalImages": 2,
      "includeOriginal": true,
      "totalSize": 2048000
    }
  }
}
```

### 5. AI图片生成
- **接口**: `POST /api/image/generate`
- **描述**: 根据提示词生成AI图片
- **认证**: 需要Bearer Token
- **请求参数**:
```json
{
  "prompt": "图片生成提示词",
  "numberOfImages": 1,
  "sceneType": "ai_generate"
}
```

## 场景管理接口 (/api/scenes)

### 1. 获取场景分类
- **接口**: `GET /api/scenes/categories`
- **描述**: 获取所有场景分类和场景列表
- **认证**: 需要Bearer Token
- **响应数据**:
```json
{
  "code": 200,
  "data": [
    {
      "id": "分类ID",
      "name": "分类名称",
      "icon": "图标",
      "isCustom": false,
      "scenes": [
        {
          "id": "场景ID",
          "name": "场景名称",
          "icon": "图标",
          "type": "场景类型",
          "description": "描述",
          "prompt": "默认提示词"
        }
      ]
    }
  ]
}
```

### 2. 获取场景详情
- **接口**: `GET /api/scenes/:sceneId`
- **描述**: 获取指定场景的详细配置
- **认证**: 需要Bearer Token

### 3. 创建自定义场景
- **接口**: `POST /api/scenes`
- **描述**: 创建用户自定义场景
- **认证**: 需要Bearer Token
- **请求参数**:
```json
{
  "name": "场景名称",
  "description": "场景描述",
  "categoryId": "分类ID",
  "type": "场景类型",
  "prompt": "默认提示词",
  "config": {}
}
```

## AI模型配置接口 (/api/models)

### 1. 获取模型配置列表
- **接口**: `GET /api/models/configs`
- **描述**: 获取用户的AI模型配置列表
- **认证**: 需要Bearer Token
- **响应数据**:
```json
{
  "code": 200,
  "data": [
    {
      "id": "配置ID",
      "name": "模型名称",
      "description": "模型描述",
      "apiUrl": "API地址",
      "apiKey": "***",
      "modelName": "模型名称",
      "defaultModel": "默认模型",
      "supportCustomModel": true,
      "temperature": 0.7,
      "maxTokens": 2048,
      "timeout": 30000,
      "isConfigured": true,
      "isDefault": false
    }
  ]
}
```

### 2. 保存模型配置
- **接口**: `POST /api/models/configs`
- **描述**: 保存或更新AI模型配置
- **认证**: 需要Bearer Token
- **请求参数**:
```json
{
  "modelId": "模型ID",
  "apiUrl": "API地址",
  "apiKey": "API密钥",
  "modelName": "模型名称",
  "temperature": 0.7,
  "maxTokens": 2048,
  "timeout": 30000
}
```

### 3. 测试模型连接
- **接口**: `POST /api/models/test-connection`
- **描述**: 测试AI模型API连接
- **认证**: 需要Bearer Token
- **请求参数**:
```json
{
  "modelId": "模型ID",
  "apiUrl": "API地址",
  "apiKey": "API密钥",
  "modelName": "模型名称"
}
```

### 4. 设置默认模型
- **接口**: `PUT /api/models/default/:configId`
- **描述**: 设置默认使用的AI模型
- **认证**: 需要Bearer Token

## 处理历史接口 (/api/history)

### 1. 获取处理历史
- **接口**: `GET /api/history/photos`
- **描述**: 获取用户的图片处理历史记录
- **认证**: 需要Bearer Token
- **查询参数**:
  - `page`: 页码（默认1）
  - `pageSize`: 每页数量（默认20）
  - `sceneType`: 场景类型筛选
  - `startDate`: 开始日期
  - `endDate`: 结束日期
- **响应数据**:
```json
{
  "code": 200,
  "data": {
    "list": [
      {
        "id": "记录ID",
        "sceneType": "场景类型",
        "sceneName": "场景名称",
        "status": "completed",
        "createdAt": "创建时间",
        "updatedAt": "更新时间",
        "thumbnail": "缩略图URL",
        "imageCount": 2,
        "hasTextResponse": true
      }
    ],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 100,
      "totalPages": 5
    }
  }
}
```

### 2. 获取历史详情
- **接口**: `GET /api/history/photos/:processId`
- **描述**: 获取指定处理记录的详细信息
- **认证**: 需要Bearer Token

### 3. 删除历史记录
- **接口**: `DELETE /api/history/photos/:processId`
- **描述**: 删除指定的处理记录（软删除）
- **认证**: 需要Bearer Token

### 4. 获取回收站
- **接口**: `GET /api/history/trash`
- **描述**: 获取已删除的处理记录
- **认证**: 需要Bearer Token

### 5. 恢复记录
- **接口**: `PUT /api/history/restore/:processId`
- **描述**: 从回收站恢复处理记录
- **认证**: 需要Bearer Token

### 6. 彻底删除
- **接口**: `DELETE /api/history/permanent/:processId`
- **描述**: 彻底删除处理记录
- **认证**: 需要Bearer Token

## 文件上传接口 (/api/upload)

### 1. 获取上传凭证
- **接口**: `GET /api/upload/token`
- **描述**: 获取文件上传凭证和配置
- **认证**: 需要Bearer Token
- **查询参数**:
  - `fileType`: 文件类型（image/avatar）
  - `fileName`: 文件名
- **响应数据**:
```json
{
  "code": 200,
  "data": {
    "uploadUrl": "上传地址",
    "token": "上传令牌",
    "key": "文件键",
    "expires": 1640995200000,
    "maxFileSize": 10485760,
    "allowedTypes": ["image/jpeg", "image/png"]
  }
}
```

### 2. 单文件上传
- **接口**: `POST /api/upload/file`
- **描述**: 上传单个文件
- **认证**: 需要Bearer Token
- **请求类型**: multipart/form-data
- **请求参数**:
  - `file`: 文件
  - `fileType`: 文件类型

### 3. 多文件上传
- **接口**: `POST /api/upload/files`
- **描述**: 批量上传多个文件
- **认证**: 需要Bearer Token
- **请求类型**: multipart/form-data
- **请求参数**:
  - `files`: 文件数组
  - `fileType`: 文件类型

## 系统设置接口 (/api/settings)

### 1. 获取应用设置
- **接口**: `GET /api/settings/app`
- **描述**: 获取用户的应用设置
- **认证**: 需要Bearer Token
- **响应数据**:
```json
{
  "code": 200,
  "data": {
    "theme": "light",
    "language": "zh-CN",
    "autoSave": true,
    "imageQuality": "high",
    "notifications": {
      "processComplete": true,
      "systemUpdate": true
    }
  }
}
```

### 2. 更新应用设置
- **接口**: `PUT /api/settings/app`
- **描述**: 更新用户的应用设置
- **认证**: 需要Bearer Token
- **请求参数**:
```json
{
  "theme": "light|dark",
  "language": "zh-CN|en-US",
  "autoSave": true,
  "imageQuality": "low|medium|high",
  "notifications": {
    "processComplete": true,
    "systemUpdate": true
  }
}
```

### 3. 获取安全设置
- **接口**: `GET /api/settings/security`
- **描述**: 获取用户的安全设置
- **认证**: 需要Bearer Token

### 4. 更新双因子认证
- **接口**: `PUT /api/settings/security/two-factor`
- **描述**: 启用或禁用双因子认证
- **认证**: 需要Bearer Token

## 系统接口

### 1. 健康检查
- **接口**: `GET /health`
- **描述**: 检查服务器运行状态
- **响应数据**:
```json
{
  "status": "ok",
  "timestamp": "2024-01-01T00:00:00.000Z",
  "uptime": 3600
}
```

### 2. API文档
- **接口**: `GET /api-docs`
- **描述**: 访问Swagger API文档界面

## 错误码说明

| 错误码 | 说明 |
|--------|------|
| 200 | 请求成功 |
| 400 | 请求参数错误 |
| 401 | 未授权或令牌无效 |
| 403 | 禁止访问 |
| 404 | 资源不存在 |
| 429 | 请求过于频繁 |
| 500 | 服务器内部错误 |
| 501 | 功能未实现 |

## 认证说明

大部分接口需要在请求头中携带JWT令牌：
```
Authorization: Bearer <your_access_token>
```
令牌有效期为1小时，可通过刷新令牌接口获取新的访问令牌。

## 文件上传说明

1. 支持的图片格式：JPEG、PNG、WebP、GIF
2. 最大文件大小：10MB
3. 文件按用户ID分类存储：`uploads/{用户ID}/文件名`
4. 自动生成缩略图
5. 返回完整的文件URL

## 限流说明

- 普通接口：每分钟60次请求
- 登录/注册接口：每分钟5次请求
- 超出限制返回429错误码

## 注意事项

1. 所有时间字段均为ISO 8601格式
2. 文件URL为相对路径，需要拼接服务器地址
3. 图片处理为异步操作，需要轮询状态接口获取结果
4. 删除操作多为软删除，可通过回收站恢复
5. API支持CORS跨域请求